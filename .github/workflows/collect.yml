name: Collect Cultural Data

on:
  schedule:
    - cron: '0 4 * * *'   # 06:00 Europe/Madrid
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: data-update
  cancel-in-progress: true

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run collector (with full debug)
        env:
          PYTHONPATH: .
        run: |
          set -e
          mkdir -p data data/sources
          {
            echo "Run started: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            echo "PWD: $(pwd)"
            echo "PYTHON: $(python -V)"
            echo "PYTHONPATH: ${PYTHONPATH}"
            echo "Repo listing:"
            ls -lah
            echo "----- import test -----"
            python - <<'PY'
import sys, os, pkgutil
print("sys.path[0]:", sys.path[0])
print("cwd:", os.getcwd())
print("has scrapers pkg?", any(m.name=="scrapers" for m in pkgutil.iter_modules()))
PY
            echo "----- collector output -----"
            python -m scrapers.collector
            EXIT=$?
            echo "collector exit code: $EXIT"
            echo "Run finished: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            echo "=== DATA DIR LISTING ==="
            ls -lah data
          } > data/run.log 2>&1 || true

      - name: Show run.log
        run: |
          echo "----- data/run.log -----"
          cat data/run.log || true

      - name: Auto-commit data changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(data): update cultural catalog"
          file_pattern: data/**
          push_options: '--force-with-lease'
